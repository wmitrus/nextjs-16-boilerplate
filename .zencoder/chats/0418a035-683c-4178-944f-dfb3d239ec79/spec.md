# Technical Specification

## Enterprise-Ready Multi-Tenant SaaS Infrastructure

**Reference PRD**: `requirements.md`  
**Target**: Next.js 16, TypeScript strict, Drizzle ORM, PostgreSQL

---

## 1. Technical Context

### Language & Runtime

- **TypeScript** `^5`, strict mode (`tsconfig.json`)
- **Node.js** `24.x`
- **Next.js** `16.1.6` (App Router, Turbopack, React Compiler enabled)

### Existing Dependencies (relevant)

| Package              | Version  | Purpose                  |
| -------------------- | -------- | ------------------------ |
| `next`               | 16.1.6   | Framework                |
| `@clerk/nextjs`      | ^6.39.0  | Auth provider (Clerk)    |
| `@t3-oss/env-nextjs` | ^0.13.10 | Type-safe env validation |
| `zod`                | ^4.3.6   | Schema validation        |

### New Dependencies Required

| Package       | Version | Purpose                                  |
| ------------- | ------- | ---------------------------------------- |
| `drizzle-orm` | ^0.44.x | ORM                                      |
| `drizzle-kit` | ^0.31.x | Migrations CLI (devDep)                  |
| `postgres`    | ^3.4.x  | PostgreSQL driver (`postgres` / pg wire) |

### Path Aliases (tsconfig.json)

```
@/features/*  → src/features/*
@/shared/*    → src/shared/*
@/core/*      → src/core/*
@/*           → src/*
```

---

## 2. Architectural Principles (Non-negotiable)

1. **Domain** files (`modules/*/domain/`) have zero imports from: ORM, Clerk, OpenFeature, `env`, logger.
2. **Repositories** return domain types only. DB row types stay within `infrastructure/drizzle/`.
3. **Container** (`src/core/container/index.ts`) is the composition root — the only place that knows about adapters.
4. **env** is only imported in infrastructure, container, and configuration layer. Never in domain.
5. **Billing → DB → Authorization**: unidirectional data flow via `tenant_attributes` table.

---

## 3. Source Code Structure Changes

### 3.1 New Files & Directories

```
src/
├── core/
│   ├── contracts/
│   │   └── feature-flags.ts              [NEW] FeatureFlagService interface
│   ├── db/
│   │   ├── client.ts                     [NEW] Drizzle db client singleton
│   │   └── index.ts                      [NEW] re-export
│   └── env.ts                            [MODIFY] add DATABASE_URL, DB_PROVIDER, AUTH_PROVIDER
│
├── modules/
│   ├── auth/
│   │   ├── infrastructure/
│   │   │   ├── clerk/
│   │   │   │   └── ClerkRequestIdentitySource.ts   [MOVE from infrastructure/]
│   │   │   ├── authjs/
│   │   │   │   └── AuthJsRequestIdentitySource.ts  [NEW placeholder]
│   │   │   ├── supabase/
│   │   │   │   └── SupabaseRequestIdentitySource.ts [NEW placeholder]
│   │   │   └── system/
│   │   │       └── SystemIdentitySource.ts          [NEW]
│   │   └── index.ts                                 [MODIFY] AUTH_PROVIDER switch
│   │
│   ├── authorization/
│   │   └── infrastructure/
│   │       ├── drizzle/
│   │       │   ├── schema.ts                        [NEW] Drizzle table defs
│   │       │   ├── DrizzleRoleRepository.ts         [NEW]
│   │       │   ├── DrizzleMembershipRepository.ts   [NEW]
│   │       │   ├── DrizzlePolicyRepository.ts       [NEW]
│   │       │   └── DrizzleTenantAttributesRepository.ts [NEW]
│   │       └── memory/
│   │           └── InMemoryRepositories.ts          [REMOVE after Phase 4]
│   │
│   ├── billing/                                     [NEW module]
│   │   ├── domain/
│   │   │   ├── BillingService.ts                    [NEW] interface
│   │   │   └── SubscriptionStatus.ts                [NEW] domain type
│   │   ├── infrastructure/
│   │   │   └── stripe/
│   │   │       └── StripeBillingService.ts          [NEW placeholder]
│   │   └── index.ts                                 [NEW]
│   │
│   └── feature-flags/                              [NEW module]
│       ├── infrastructure/
│       │   ├── memory/
│       │   │   └── InMemoryFeatureFlagService.ts    [NEW]
│       │   └── openfeature/
│       │       └── OpenFeatureFeatureFlagService.ts [NEW placeholder]
│       └── index.ts                                 [NEW]
│
└── migrations/                                      [NEW] drizzle-kit output
    └── (generated by drizzle-kit)
```

### 3.2 Modified Files

| File                                 | Change                                                     |
| ------------------------------------ | ---------------------------------------------------------- |
| `src/core/env.ts`                    | Add `DATABASE_URL`, `DB_PROVIDER`, `AUTH_PROVIDER`         |
| `src/core/contracts/index.ts`        | Add `FEATURE_FLAGS` symbol keys                            |
| `src/modules/auth/index.ts`          | Switch on `AUTH_PROVIDER` env                              |
| `src/modules/authorization/index.ts` | Switch on `DB_PROVIDER` env; remove InMemory after Phase 4 |
| `.env.example`                       | Add `DATABASE_URL`, `DB_PROVIDER`, `AUTH_PROVIDER`         |

---

## 4. Interface & Contract Changes

### 4.1 New: `src/core/contracts/feature-flags.ts`

```typescript
import type { AuthorizationContext } from './authorization';

export interface FeatureFlagService {
  isEnabled(flag: string, context: AuthorizationContext): Promise<boolean>;
}
```

### 4.2 Updated: `src/core/contracts/index.ts`

```typescript
export const FEATURE_FLAGS = {
  SERVICE: Symbol('FeatureFlagService'),
};
```

### 4.3 New: `src/modules/auth/infrastructure/system/SystemIdentitySource.ts`

```typescript
import type {
  RequestIdentitySource,
  RequestIdentitySourceData,
} from '@/core/contracts/identity';

export class SystemIdentitySource implements RequestIdentitySource {
  async get(): Promise<RequestIdentitySourceData> {
    return {
      userId: 'system',
      orgId: 'system',
      email: undefined,
    };
  }
}
```

### 4.4 Placeholder pattern for AuthJS/Supabase

```typescript
// AuthJsRequestIdentitySource.ts
export class AuthJsRequestIdentitySource implements RequestIdentitySource {
  async get(): Promise<RequestIdentitySourceData> {
    throw new Error('AuthJsRequestIdentitySource: not implemented');
  }
}
```

---

## 5. Drizzle Schema Design

### 5.1 File: `src/modules/authorization/infrastructure/drizzle/schema.ts`

```typescript
import {
  boolean,
  index,
  integer,
  jsonb,
  pgEnum,
  pgTable,
  primaryKey,
  text,
  timestamp,
  unique,
  uuid,
} from 'drizzle-orm/pg-core';

export const subscriptionStatusEnum = pgEnum('subscription_status', [
  'incomplete',
  'trialing',
  'active',
  'past_due',
  'canceled',
  'unpaid',
]);

export const contractTypeEnum = pgEnum('contract_type', [
  'standard',
  'enterprise',
]);

export const usersTable = pgTable(
  'users',
  {
    id: uuid('id').primaryKey(),
    email: text('email').unique().notNull(),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (t) => [index('idx_users_email').on(t.email)],
);

export const tenantsTable = pgTable('tenants', {
  id: uuid('id').primaryKey(),
  name: text('name').notNull(),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});

export const rolesTable = pgTable(
  'roles',
  {
    id: uuid('id').primaryKey(),
    tenantId: uuid('tenant_id')
      .notNull()
      .references(() => tenantsTable.id, { onDelete: 'cascade' }),
    name: text('name').notNull(),
    isSystem: boolean('is_system').notNull().default(false),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (t) => [
    unique('unique_role_name_per_tenant').on(t.tenantId, t.name),
    index('idx_roles_tenant').on(t.tenantId),
  ],
);

export const membershipsTable = pgTable(
  'memberships',
  {
    userId: uuid('user_id')
      .notNull()
      .references(() => usersTable.id, { onDelete: 'cascade' }),
    tenantId: uuid('tenant_id')
      .notNull()
      .references(() => tenantsTable.id, { onDelete: 'cascade' }),
    roleId: uuid('role_id')
      .notNull()
      .references(() => rolesTable.id, { onDelete: 'restrict' }),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (t) => [
    primaryKey({ columns: [t.userId, t.tenantId] }),
    index('idx_memberships_tenant_user').on(t.tenantId, t.userId),
    index('idx_memberships_user').on(t.userId),
  ],
);

export const policiesTable = pgTable(
  'policies',
  {
    id: uuid('id').primaryKey(),
    tenantId: uuid('tenant_id').references(() => tenantsTable.id, {
      onDelete: 'cascade',
    }),
    roleId: uuid('role_id').references(() => rolesTable.id, {
      onDelete: 'cascade',
    }),
    effect: text('effect', { enum: ['allow', 'deny'] }).notNull(),
    resource: text('resource').notNull(),
    actions: jsonb('actions').$type<string[]>().notNull(),
    conditions: jsonb('conditions').$type<Record<string, unknown>>(),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (t) => [
    index('idx_policies_tenant').on(t.tenantId),
    index('idx_policies_role').on(t.roleId),
    index('idx_policies_resource').on(t.resource),
  ],
);

export const tenantAttributesTable = pgTable(
  'tenant_attributes',
  {
    tenantId: uuid('tenant_id')
      .primaryKey()
      .references(() => tenantsTable.id, { onDelete: 'cascade' }),
    plan: text('plan').notNull(),
    contractType: contractTypeEnum('contract_type')
      .notNull()
      .default('standard'),
    features: jsonb('features').$type<string[]>().notNull().default([]),
    maxUsers: integer('max_users').notNull().default(5),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
    updatedAt: timestamp('updated_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (t) => [index('idx_tenant_attributes_plan').on(t.plan)],
);

export const subscriptionsTable = pgTable(
  'subscriptions',
  {
    id: uuid('id').primaryKey(),
    tenantId: uuid('tenant_id')
      .notNull()
      .references(() => tenantsTable.id, { onDelete: 'cascade' }),
    provider: text('provider').notNull(),
    providerSubscriptionId: text('provider_subscription_id').notNull(),
    status: subscriptionStatusEnum('status').notNull(),
    currentPeriodEnd: timestamp('current_period_end', { withTimezone: true }),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (t) => [
    unique('unique_provider_subscription').on(
      t.provider,
      t.providerSubscriptionId,
    ),
    index('idx_subscriptions_tenant').on(t.tenantId),
    index('idx_subscriptions_status').on(t.status),
  ],
);
```

### 5.2 DB Client: `src/core/db/client.ts`

```typescript
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import { env } from '@/core/env';

const sql = postgres(env.DATABASE_URL);
export const db = drizzle(sql);
```

---

## 6. Repository Implementations

### 6.1 DrizzleRoleRepository

```typescript
// Returns role name strings (domain type: RoleId = string)
// Query: SELECT roles.name FROM memberships JOIN roles ON roles.id = memberships.role_id
//        WHERE memberships.user_id = $userId AND memberships.tenant_id = $tenantId
```

### 6.2 DrizzleMembershipRepository

```typescript
// Returns: boolean
// Query: SELECT 1 FROM memberships WHERE user_id = $userId AND tenant_id = $tenantId LIMIT 1
```

### 6.3 DrizzlePolicyRepository

```typescript
// Returns: Policy[] (domain type — no ORM types exposed)
// Query: SELECT * FROM policies WHERE (tenant_id = $tenantId OR tenant_id IS NULL)
//                                 AND (role_id IN $roles OR role_id IS NULL)
// Maps DB row conditions (jsonb) to Policy.condition function via ConditionEvaluator
```

**Important**: DB policies store ABAC conditions as JSON. The `DrizzlePolicyRepository` must deserialize the `conditions` JSON column into a typed `condition?: (ctx) => boolean | Promise<boolean>` function.

Condition mapping strategy: Define a `deserializeCondition` helper in `infrastructure/drizzle/` only, that converts stored JSON predicates (`{ type: 'hasAttribute', key: '...', value: '...' }`) into callables using the existing `ConditionEvaluator` helpers.

### 6.4 DrizzleTenantAttributesRepository

```typescript
// Returns: TenantAttributes (domain type from core/contracts/authorization.ts)
// Query: SELECT * FROM tenant_attributes WHERE tenant_id = $tenantId
// Maps: plan, contract_type, features, max_users → TenantAttributes
// On not found: return neutral defaults (same as InMemory)
```

---

## 7. Environment Variables

### 7.1 Additions to `src/core/env.ts` (server section)

```typescript
DATABASE_URL: z.string().url().optional(),
DB_PROVIDER: z.enum(['drizzle']).default('drizzle'),
AUTH_PROVIDER: z.enum(['clerk', 'authjs', 'supabase']).default('clerk'),
```

- `DATABASE_URL` is optional in schema (required at runtime for Drizzle repos).
- `DB_PROVIDER` defaults to `'drizzle'` — future-proofed for Prisma.
- `AUTH_PROVIDER` defaults to `'clerk'`.

### 7.2 `.env.example` additions

```
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/mydb
DB_PROVIDER=drizzle

# Auth Provider (clerk | authjs | supabase)
AUTH_PROVIDER=clerk
```

---

## 8. Container Wiring

### 8.1 `src/modules/auth/index.ts` (AUTH_PROVIDER switch)

```typescript
function buildIdentitySource(authProvider: string): RequestIdentitySource {
  switch (authProvider) {
    case 'clerk':
      return new ClerkRequestIdentitySource();
    case 'authjs':
      return new AuthJsRequestIdentitySource();
    case 'supabase':
      return new SupabaseRequestIdentitySource();
    default:
      throw new Error(`Unknown AUTH_PROVIDER: ${authProvider}`);
  }
}
```

### 8.2 `src/modules/authorization/index.ts` (DB_PROVIDER switch)

```typescript
function buildRepositories(nodeEnv: string, dbProvider: string) {
  if (nodeEnv === 'test') {
    return {
      /* Mock repos */
    };
  }
  switch (dbProvider) {
    case 'drizzle':
      return {
        policyRepository: new DrizzlePolicyRepository(db),
        roleRepository: new DrizzleRoleRepository(db),
        membershipRepository: new DrizzleMembershipRepository(db),
        tenantAttributesRepository: new DrizzleTenantAttributesRepository(db),
      };
    default:
      throw new Error(
        `[authorizationModule] Unknown DB_PROVIDER: ${dbProvider}. ` +
          'Only "drizzle" is supported.',
      );
  }
}
```

---

## 9. Feature Flag Module

### 9.1 Contract: `src/core/contracts/feature-flags.ts`

(see §4.1)

### 9.2 InMemoryFeatureFlagService (test adapter)

```typescript
// All flags disabled by default; configurable via constructor map
export class InMemoryFeatureFlagService implements FeatureFlagService {
  constructor(private readonly flags: Record<string, boolean> = {}) {}
  async isEnabled(
    flag: string,
    _context: AuthorizationContext,
  ): Promise<boolean> {
    return this.flags[flag] ?? false;
  }
}
```

### 9.3 OpenFeatureFeatureFlagService (placeholder)

```typescript
export class OpenFeatureFeatureFlagService implements FeatureFlagService {
  async isEnabled(
    _flag: string,
    _context: AuthorizationContext,
  ): Promise<boolean> {
    throw new Error('OpenFeatureFeatureFlagService: not implemented');
  }
}
```

### 9.4 Feature flags are NOT wired into AuthorizationService in this phase

The contract is defined. Integration with `DefaultAuthorizationService` is a future incremental step to avoid scope creep.

---

## 10. Billing Module

### 10.1 Domain types

```typescript
// SubscriptionStatus.ts
export type SubscriptionStatus =
  | 'incomplete'
  | 'trialing'
  | 'active'
  | 'past_due'
  | 'canceled'
  | 'unpaid';

// BillingService.ts
export interface BillingService {
  handleWebhookEvent(event: unknown): Promise<void>;
  syncSubscription(
    tenantId: string,
    externalSubscriptionId: string,
  ): Promise<void>;
}
```

### 10.2 Stripe placeholder

```typescript
// StripeBillingService.ts
export class StripeBillingService implements BillingService {
  async handleWebhookEvent(_event: unknown): Promise<void> {
    throw new Error('StripeBillingService: not implemented');
  }
  async syncSubscription(
    _tenantId: string,
    _externalSubscriptionId: string,
  ): Promise<void> {
    throw new Error('StripeBillingService: not implemented');
  }
}
```

### 10.3 Billing module index

Module is defined but not registered in the main container yet (no active billing operations in this phase).

---

## 11. Drizzle Configuration

### 11.1 `drizzle.config.ts` (project root)

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  schema: './src/modules/authorization/infrastructure/drizzle/schema.ts',
  out: './src/migrations',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

### 11.2 `package.json` scripts additions

```json
"db:generate": "drizzle-kit generate",
"db:migrate": "drizzle-kit migrate",
"db:studio": "drizzle-kit studio"
```

---

## 12. Testing Strategy

### 12.1 Unit Tests (co-located, `.test.ts`)

| File                                        | Tests                                           |
| ------------------------------------------- | ----------------------------------------------- |
| `SystemIdentitySource.test.ts`              | Returns `{ userId: 'system', orgId: 'system' }` |
| `DrizzleRoleRepository.test.ts`             | Integration test with test DB                   |
| `DrizzleMembershipRepository.test.ts`       | Integration test                                |
| `DrizzlePolicyRepository.test.ts`           | Integration test + condition deserialization    |
| `DrizzleTenantAttributesRepository.test.ts` | Integration test + defaults on missing          |
| `InMemoryFeatureFlagService.test.ts`        | Flag enabled/disabled, default false            |

### 12.2 Integration Tests

- Drizzle repositories use `vitest.integration.config.ts` (existing pattern)
- Use test DB with `DATABASE_URL` pointing to a test PostgreSQL instance

### 12.3 Existing tests must continue passing

- `src/modules/authorization/domain/` tests — unchanged (pure domain)
- `src/proxy.test.ts` — unchanged
- `src/core/container/index.test.ts` — may need update for new env vars

---

## 13. Delivery Phases (Incremental & Testable)

### Phase 1 — Identity Axis Finalization

**Files**: `SystemIdentitySource.ts`, `AuthJsRequestIdentitySource.ts`, `SupabaseRequestIdentitySource.ts`, `auth/index.ts`, `env.ts` (AUTH_PROVIDER)
**Test**: `SystemIdentitySource.test.ts`
**Verify**: `pnpm typecheck && pnpm lint`

### Phase 2 — Env & DB Setup

**Files**: `env.ts` (DATABASE_URL, DB_PROVIDER), `core/db/client.ts`, `drizzle.config.ts`, `package.json` (db:\* scripts)
**Test**: env schema validation
**Verify**: `pnpm env:check && pnpm typecheck`

### Phase 3 — Drizzle Schema

**Files**: `authorization/infrastructure/drizzle/schema.ts`
**Test**: `pnpm db:generate` (migration generated, no DB needed)
**Verify**: `pnpm typecheck`

### Phase 4 — Drizzle Repositories

**Files**: `DrizzleRoleRepository.ts`, `DrizzleMembershipRepository.ts`, `DrizzlePolicyRepository.ts`, `DrizzleTenantAttributesRepository.ts`
**Test**: Integration tests (require test DB)
**Verify**: `pnpm typecheck && pnpm lint`

### Phase 5 — Container Wiring & InMemory Removal

**Files**: `authorization/index.ts` (DB_PROVIDER switch), remove `memory/InMemoryRepositories.ts`
**Test**: `src/core/container/index.test.ts`
**Verify**: `pnpm test && pnpm typecheck`

### Phase 6 — Feature Flag Module

**Files**: `core/contracts/feature-flags.ts`, `feature-flags/infrastructure/memory/`, `feature-flags/infrastructure/openfeature/`, `contracts/index.ts`
**Test**: `InMemoryFeatureFlagService.test.ts`
**Verify**: `pnpm test && pnpm typecheck && pnpm lint`

### Phase 7 — Billing Module

**Files**: `billing/domain/`, `billing/infrastructure/stripe/`, `billing/index.ts`
**Test**: No runtime tests (placeholder only; type check only)
**Verify**: `pnpm typecheck && pnpm lint`

### Phase 8 — .env.example & Final Verification

**Files**: `.env.example`, verify `pnpm env:check`
**Verify**: `pnpm typecheck && pnpm lint && pnpm test`

---

## 14. Verification Commands

```bash
pnpm typecheck       # TypeScript strict mode — must pass with 0 errors
pnpm lint            # ESLint 9 flat config — must pass with 0 errors
pnpm test            # vitest unit tests — all must pass
pnpm env:check       # env consistency check — must pass
pnpm madge           # circular dependency check — must pass
pnpm skott:check:only # dependency graph — must pass
```

---

## 15. Guardrails Checklist (pre-implementation)

- [ ] No domain file imports from `drizzle-orm`
- [ ] No domain file imports from `@clerk/nextjs`
- [ ] No domain file imports from `@/core/env`
- [ ] Repositories return only domain types
- [ ] `InMemoryRepositories.ts` deleted in Phase 5 (not before)
- [ ] `MockRepositories.ts` preserved for tests
- [ ] `DrizzlePolicyRepository` does NOT deserialize conditions using domain business logic — uses ConditionEvaluator helpers only
- [ ] `BillingService` has no import from `AuthorizationService`
- [ ] `AuthorizationService` has no import from billing module
