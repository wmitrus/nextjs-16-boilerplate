sequenceDiagram

participant UI as Next.js Route / Action
participant UC as Application UseCase
participant IDP as IdentityProvider
participant TR as TenantResolver
participant AUTHZ as AuthorizationService
participant ENGINE as PolicyEngine (Domain)
participant REPO as Repositories
participant INFRA as Infrastructure

UI->>UC: Execute UseCase
UC->>IDP: getCurrentIdentity()
IDP-->>UC: Identity
UC->>TR: resolve(identity)
TR-->>UC: TenantContext
UC->>AUTHZ: can(context)
AUTHZ->>ENGINE: evaluate policies
ENGINE->>REPO: fetch roles/policies
REPO->>INFRA: DB call
INFRA-->>REPO: Data
ENGINE-->>AUTHZ: allow/deny
AUTHZ-->>UC: boolean
UC-->>UI: Result