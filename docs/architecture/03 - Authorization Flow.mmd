flowchart TD
    %% Traceability: src/proxy.ts, src/security/middleware/with-auth.ts, src/security/core/security-context.ts,
    %% src/security/core/security-dependencies.ts, src/security/core/authorization-facade.ts,
    %% src/modules/auth/infrastructure/ClerkIdentityProvider.ts, src/modules/auth/infrastructure/ClerkUserRepository.ts,
    %% src/modules/authorization/domain/AuthorizationService.ts
    REQ[Incoming request] --> PROXY[proxy.ts]
    PROXY --> ROOT[createContainer()]
    ROOT --> DEPS[buildSecurityDependencies(container)]
    DEPS --> AUTH[withAuth / withSecurity]

    AUTH --> IDP[IdentityProvider]
    AUTH --> USERREPO[UserRepository]
    AUTH --> AUTHZ[AuthorizationService]

    IDP --> IDENTITY[Identity]
    IDENTITY --> CTX[createSecurityContext]
    USERREPO --> CTX
    AUTHZ --> FACADE[new AuthorizationFacade]
    CTX --> FACADE

    FACADE --> DECISION{Allow?}
    DECISION -->|Yes| NEXT[NextResponse.next()]
    DECISION -->|No| DENY[Unauthorized / Redirect]